{% extends "base.html" %}
{% block content %}

<section class="cyber-metro-section">
    <div class="cyber-container">
        <header class="map-header">
            <h1 class="gradient-text">Metro Manila Rail Transit Map</h1>
            <p class="subtitle">Click the stations to plan your travel route</p>
        </header>
        <div class="map-layout-wrapper">
            
            <div class="svg-map-area">
                <svg id="metro-svg" viewBox="0 0 1000 800" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>

                    <g id="base-tracks">
                        <path id="path-lrt1" class="track lrt1-track" d="M 450,50 L  400,60 L  350,80 L  300,100  L 250,150 L 250,550 L 300,770" />
                        <path id="path-lrt2" class="track lrt2-track" d="M 250,260 L 520,220 L 750,220 L 880,180" />
                        <path id="path-mrt3" class="track mrt3-track" d="M 480,50 L 630,170 L 630,380 L 630,400 L 520,480 L 300,515 L 250,530" />
                    </g>

                    <g id="stations-layer">
                        {% for line_id, line_stations in stations.items() %}
                            {% if line_id != 'interchanges' %}
                                {% for s in line_stations %}
                                <g class="station-node-group {{ line_id }}" data-name="{{ s }}" onclick="selectStation('{{ s }}', this)">
                                    <circle class="station-dot" r="4.5" />
                                    <text class="station-text">{{ s.split(' (')[0] }}</text>
                                </g>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </g>

                    <!-- Legend in bottom-right -->
                    <g id="legend-group" transform="translate(820, 700)">
                        <!-- Background rectangle -->
                        <rect width="160" height="90" fill="rgba(10, 20, 50, 0.9)" stroke="rgba(100, 200, 255, 0.5)" stroke-width="1" rx="4"/>
                        
                        <!-- LRT-1 (Yellow) -->
                        <rect x="10" y="10" width="10" height="10" fill="#FFD700" rx="1"/>
                        <text x="25" y="19" style="fill: #ffffff; font-size: 11px; font-family: Arial, sans-serif;">LRT-1</text>
                        
                        <!-- MRT-3 (Blue) -->
                        <rect x="10" y="30" width="10" height="10" fill="#4169E1" rx="1"/>
                        <text x="25" y="39" style="fill: #ffffff; font-size: 11px; font-family: Arial, sans-serif;">MRT-3</text>
                        
                        <!-- LRT-2 (Purple) -->
                        <rect x="10" y="50" width="10" height="10" fill="#9370DB" rx="1"/>
                        <text x="25" y="59" style="fill: #ffffff; font-size: 11px; font-family: Arial, sans-serif;">LRT-2</text>
                    </g>
                </svg>
            </div>

            <aside class="cyber-panel">
                <h3 class="panel-title">Trip Planner</h3>
                
                <div class="selection-box">
                    <div class="input-display">
                        <label>STARTING STATION</label>
                        <div id="start_display" class="glow-text">--</div>
                    </div>
                    <div class="input-display">
                        <label>TARGET DESTINATION</label>
                        <div id="end_display" class="glow-text">--</div>
                    </div>
                </div>

                <form method="POST" action="/graph" id="routeForm">
                    <input type="hidden" name="start_station" id="start_input">
                    <input type="hidden" name="end_station" id="end_input">
                    <button type="submit" class="cyber-button">
                        CALCULATE ROUTE ðŸš€
                    </button>
                </form>

                {% if route %}
                <div class="itinerary-results animate-up" style="margin-top: 25px;">
                    <h4 class="panel-title" style="font-size: 0.7rem;">Itinerary</h4>
                    <div class="path-visual">
                        {% for station in route %}
                        <div class="path-step">
                            <span class="step-dot {{ station.line|lower }}"></span>
                            <span class="glow-text" style="font-size: 0.75rem;">{{ station.name }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="cyber-button secondary-reset" onclick="window.location.href='/graph'">
                        CLEAR MAP
                    </button>
                </div>
                {% endif %}
            </aside>
        </div>

    </div>
</section>

<script src="{{ url_for('static', filename='js/metro-map.js') }}"></script>
<script>
    // This part runs AFTER the page reloads with route data
    {% if route %}
        const routeData = {{ route|map(attribute='name')|list|tojson }};
        window.addEventListener('load', () => highlightRouteOnMap(routeData));
    {% endif %}
</script>

{% endblock %}