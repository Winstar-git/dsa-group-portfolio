{% extends "base.html" %}
{% block content %}

<section class="cyber-metro-section">
    <div class="cyber-container">
        <div class="map-layout-wrapper">
            
            <div class="svg-map-area">
                <svg id="metro-svg" viewBox="0 0 1000 800" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>

                    <g id="base-tracks">
                        <path id="path-lrt1" class="track lrt1-track" d="M 250,50 L 250,700 Q 250,770 350,770" />
                        <path id="path-lrt2" class="track lrt2-track" d="M 250,450 L 450,450 L 750,350 L 950,200" />
                        <path id="path-mrt3" class="track mrt3-track" d="M 250,50 L 750,50 L 750,650 L 250,650" />
                    </g>

                    <g id="stations-layer">
                        {% for line_id, line_stations in stations.items() %}
                            {% if line_id != 'interchanges' %}
                                {% for s in line_stations %}
                                <g class="station-node-group {{ line_id }}" data-name="{{ s }}" onclick="selectStation('{{ s }}', this)">
                                    <circle class="station-dot" r="4.5" />
                                    <text class="station-text">{{ s.split(' (')[0] }}</text>
                                </g>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </g>
                </svg>
            </div>

            <aside class="cyber-panel">
                <h3 class="panel-title">Trip Planner</h3>
                
                <div class="selection-box">
                    <div class="input-display">
                        <label>STARTING STATION</label>
                        <div id="start_display" class="glow-text">--</div>
                    </div>
                    <div class="input-display">
                        <label>TARGET DESTINATION</label>
                        <div id="end_display" class="glow-text">--</div>
                    </div>
                </div>

                <form method="POST" action="/graph" id="routeForm">
                    <input type="hidden" name="start_station" id="start_input">
                    <input type="hidden" name="end_station" id="end_input">

                    <div class="input-display" style="margin-bottom: 20px;">
                        <label>SEARCH STRATEGY</label>
                        <select name="search_type">
                            <option value="BFS">BFS (Shortest Route)</option>
                            <option value="DFS">DFS (Alternative Route)</option>
                        </select>
                    </div>

                    <button type="submit" class="cyber-button">
                        CALCULATE ROUTE ðŸš€
                    </button>
                </form>

                {% if route %}
                <div class="itinerary-results animate-up" style="margin-top: 25px;">
                    <h4 class="panel-title" style="font-size: 0.7rem;">Itinerary</h4>
                    <div class="path-visual">
                        {% for station in route %}
                        <div class="path-step">
                            <span class="step-dot {{ station.line|lower }}"></span>
                            <span class="glow-text" style="font-size: 0.75rem;">{{ station.name }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="cyber-button secondary-reset" onclick="window.location.href='/graph'">
                        CLEAR MAP
                    </button>
                </div>
                {% endif %}
            </aside>
        </div>
    </div>
</section>

<script src="{{ url_for('static', filename='js/metro-map.js') }}"></script>
<script>
    {% if route %}
        const routeData = {{ route|map(attribute='name')|list|tojson }};
        window.addEventListener('load', () => highlightRouteOnMap(routeData));
    {% endif %}
</script>

{% endblock %}